---
title: "发版的方式"
date: 2021-08-12 14:32:14
tags:
- 个人日记
---



# 版本号
<!--more-->

`主版本号.次版本号.修订号` 或者 `X.Y.Z`

- 主版本号：当你做了不兼容的 API 修改，
- 次版本号：当你做了向下兼容的功能性新增，
- 修订号：当你做了向下兼容的问题修正。
- 先行版本号及版本编译元数据可以加到“主版本号.次版本号.修订号”的后面，作为延伸。例如
  - v1.2.34-beta
  - v1.2.34-rc



# 当发布次版本或补丁版本时

因为新版本和旧版本的api接口是向下兼容的。

## 手工

1. 新版本，先启动正常。
2. 接入LB。
3. 下旧版。

## 自动

kubernetes滚动更新

![image-20210812164504926](http://myapp.img.mykernel.cn/image-20210812164504926.png)

## 问题

当滚动更新过程中，出问题怎么办？

又要立即回滚。也需要时间。至少1-3分钟



# 当发主版本

新版本旧版本没有兼容时，一定要部署一套新的服务。

- c/s: 用户自己决定是否更新版本。(QQ) 更新后使用新版本对应的后端服务。
- b/s: 用户自己决定是登陆时选择版本，或者在页面内部请求前选择版本。

## 用户侧路由

每个新版本使用不同的域名

![image-20210812162950646](http://myapp.img.mykernel.cn/image-20210812162950646.png)

# 发布名词

## 灰度发布

让部分用户(header, ip, 域名)无感知的就派发到新的版本。验证版本是否正常。

- c/s, b/s情况，在客户端应用或vue/react打包的web页面不变的情况下。后端新版本变化。
  - cs 需要配置新的域名，重新安装包。
  - bs 直接用户选择版本。

## 金丝雀发布

金丝雀一闻到瓦斯就昏了，非常激烈。发版采用金丝雀时，流量到达时，一旦感知到这个应用返回5xx, 4xx太多，就立即将流量切回主应用。



## 蓝绿发布

后端部署新版本时，采用和原版本相同的一套新的服务

# 主次版本发布

## 次版本发布

使用[金丝雀发布](#金丝雀发布)

> 当把75%流量切到金丝雀时，下一步就更新主应用（更新过程中，25%流量在主，影响不大）。然后删除金丝雀(100%流量到达新主)。

![金丝雀发布功能和补丁版本](http://myapp.img.mykernel.cn/金丝雀发布功能和补丁版本.png)

## 主版本发布

使用金丝雀的配置，不可行。当多个ingress每个都指定canary=true时，且有相同的域名。仅第1个生效。

直接使用[蓝绿发布](#蓝绿发布)

启动新环境，保证老环境存在，原因：

- 如果直接替换老环境：会导致，[^1]你后端替换了，前端必然不可用。你打包发布了新版本，需要先上线app市场，你后端还是老版本，又不能通过。
- 所以必须启动一套新环境。使用路由方式，非常麻烦，每次需要修改nginx配置。

新版本的环境，使用新的域名。

- cs就打包使用新域名。
- bs就打包使用新域名。

[^1]: 原因，主版本发布，表示代码发生重构。可能算法变了。api不向下兼容了。

## C/S

前端程序在用户端。

**用户不升级就到达不了新版本**。

## B/S

前端程序在服务端。直接部署好前端程序，例如`code.aliyun.com`, `codeup.aliyun.com` 前期是`code`, 新版本重构后会出现`codeup`

用户可以在登陆页面，进行跳转主页时，选择版本。或者这个版本只是一个小范围，例如阿里云某些页面有回到老版本，就点一下就到达新版本。



