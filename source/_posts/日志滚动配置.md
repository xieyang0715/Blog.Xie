---
title: 日志滚动配置
date: 2021-04-22 09:06:05
tags:
- logrotate
- 生产小经验
---



# 前言

今天在处理k8s pod evicted时，发现/var/log/message日志达到67G，这个肯定是message日志太大了。

所以使用日志滚动和定期清理，`logrotate`工具，linux会默认安装此工具。



<!--more-->
# logrotate

logrotate旨在简化对生成大量日志文件的系统的管理。 它允许自动滚动，压缩，删除和邮寄日志文件。 

logrotate 配置定义的每个日志文件可以每天，每周，每月或它变得太大了，进行管理。

通常，logrotate作为daily的cron(`/etc/corn.daily/logrotate`)作业运行。如果每天运行次数超过1次，就(hourly选项定义)且指定滚动的size。

命令行上可以提供任意数量的配置文件。 以后的配置文件可能会覆盖前面给出的选项文件，因此logrotate配置文件的列出顺序很重要。 通常，一个配置文件包括应使用的任何其他配置文件。 有关如何使用include指令可完成此操作。 如果在命令行上给出了目录，则使用该目录中的每个文件作为配置文件。

如果没有给出命令行参数，logrotate将打印版本和版权信息，以及简短的用法概括。 如果轮换日志时发生任何错误，logrotate将以非零状态退出。



## 滚动周期

```bash
       /var/log/messages {
           rotate 5 
           weekly # 每周滚动一次，可有选项 hourly, weekly, daily, monthly, yearly. 默认不写是daily.
           postrotate
               /usr/bin/killall -HUP syslogd
           endscript
       }
```

定义周期后，满足周期就会滚动。

```bash
weekly      
minsize 

# 满足周期，且满足大小才滚动
```

```bash
weekly
maxsize 或 size

# 只要执行脚本，就算不满足周期，也会滚动。
```

> size
>
> 100K
>
> 100G
>
> 100M

## 备份数量

```bash
rotate count
# 0 只保留一份
```

## 备份文件名

```bash
dateext # 默认YYMMDD
dateformat format_string  非hourly默认：-%Y%m%d hourly默认：-%Y%m%d%H 
```



# 示例

每小时只要达到1G就滚动日志。

保留10个备份，一个1G，10个就100G了，总共磁盘才100G，所以满了也是要清理的。

```bash
[root@iZbp1cw3n3zzig0vil9ozrZ ~]# cat /etc/logrotate.d/syslog # 此文件由rsyslog生成
/var/log/cron
/var/log/maillog
/var/log/messages
/var/log/secure
/var/log/spooler
{
    hourly
    missingok
    size 1024M
    rotate 10
    dateext
    sharedscripts
    postrotate
	/bin/kill -HUP `cat /var/run/syslogd.pid 2> /dev/null` 2> /dev/null || true
    endscript
}
```

