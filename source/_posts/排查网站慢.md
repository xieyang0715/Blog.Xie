---
title: 排查网站慢
date: 2020-10-28 08:07:20
tags: 
- 生产小经验
- nginx
toc: true
---



# 1. 是否需要将网站静态文件走CDN?

<!--more-->

F12，响应文件需要压缩

![image-20201028161017079](http://myapp.img.mykernel.cn/image-20201028161017079.png)

响应文件大小

![image-20201028160816975](http://myapp.img.mykernel.cn/image-20201028160816975.png)

统计一分钟响应文件大小, 查看100000行，大概是3分钟的量

nginx日志格式

```nginx
log_format access_json escape=json '{"@timestamp":"$time_iso8601",'
 '"host":"$server_addr",'
 '"clientip":"$remote_addr",'
 '"size":$body_bytes_sent,'
 '"responsetime":$request_time,'
 '"upstreamtime":"$upstream_response_time",'
 '"upstreamhost":"$upstream_addr",'
 '"http_host":"$host",'
 '"url":"$uri",'
 '"domain":"$host",'
 '"xff":"$http_x_forwarded_for",'
 '"tcp_xff":"$proxy_protocol_addr",'
 '"referer":"$http_referer",'
 '"user-agent":"$http_user_agent",'
 '"method":"$request",'
 '"request-body":"$request_body",'
 '"deviceno":"$http_deviceno",'
 '"model":"$http_model",'
 '"buildversion":"$http_buildversion",'
 '"Authorization":"$http_Authorization",'
 '"status":"$status"}';
```

```bash
tail -n 100000 access-frontend-2020-10-30.log | awk -F'"' '{a=substr($15,2);split(a,b,",") ;size=b[1];url=$32; array_num[url]++;array_size[url]+=size}END{for(x in array_num){printf  "%dM %d %s\n",int(array_size[x]/1024/1024),array_num[x],x}}' | sort -rn -k1 | head


# 默认nginx日志格式
cat access.log | awk  '{url=$7;size=$10; array_num[url]++;array_size[url]+=size}END{for(x in array_num){printf  "%dM %d %s\n",int(array_size[x]/1024/1024),array_num[x],x}}' | sort -rn -k1 | head
```

![image-20201030114244753](http://myapp.img.mykernel.cn/image-20201030114244753.png)

```bash
#计算一次请求的量? 163Kbytes
[root@k8s-node1 ~]# python 
Python 2.7.5 (default, Apr  2 2020, 13:16:51) 
[GCC 4.8.5 20150623 (Red Hat 4.8.5-39)] on linux2
Type "help", "copyright", "credits" or "license" for more information.

>>> 6353 * 1024 * 1024 / 39715 /1024 
163 # 相当于一次请求163K

#实际查看一次请求的量? 64bytes
{"@timestamp":"2020-10-30T13:11:12+08:00","host":"172.16.0.221","clientip":"172.16.0.225","size":64,

#实际请求的量计算请求数?
>>> 6353 * 1024(M) * 1024(K) / 64(b/次)
104087552(相当于请求1亿次) 

#过滤大于10000(10k)？
tail -n 100000 access-frontend-2020-10-30.log  | awk -F'"' '{a=substr($15,2);split(a,b,",") ;size=b[1]; if (size>10000){print $0}}'
{"@timestamp":"2020-10-30T13:15:45+08:00","host":"172.16.0.221","clientip":"172.16.0.223","size":2568129,"responsetime":14.322,"upstreamtime":"0.291","upstreamhost":"172.16.0.225:30024","http_host":"api.youninyouqu.com","url":"/android/v1/api","domain":"api.youninyouqu.com","tcp_xff":"36.23.68.111","xff":"","referer":"","user-agent":"Mozilla/5.0 (Linux; Android 7.0; Redmi Note 4X Build/NRD90M; wv) AppleWebKit/537.36 (KHTML, like Gecko) Version/4.0 Chrome/64.0.3282.137 Mobile Safari/537.36","method":"POST /android/v1/api HTTP/1.1","request-body":"{\"params\":{\"videoid\":\"119500\"},\"method\":\"AndroidVideoAllFirstComments


# 接口响应大小. 响应越大，可能是静态文件。参考
# 请求响应时间.  重点 kibana统计响应时长, 不是看每个响应时长出现次数。
```

响应大小，参考

![image-20201030132619902](http://myapp.img.mykernel.cn/image-20201030132619902.png)



响应时间，重点分析为啥响应这么慢。

![image-20201030132345496](http://myapp.img.mykernel.cn/image-20201030132345496.png)

![image-20201030141818319](http://myapp.img.mykernel.cn/image-20201030141818319.png)



nginx日志格式默认时

```bash
awk '{array_num[$7]++;array_size[$7]+=$10}END {for(x in array_num){printf  "%dK %d %s\n",int(array_size[x]/1024),array_num[x],x}}' access.log |sort -rn -k1|head -10
```



非默认格式, 大小，时间，次数

```bash
[root@izpxkqmt2zlej4z logs]# tail -n 100000 access-frontend-2020-11-23.log  |  awk -F'"' '{miao=substr($4,0,19); a=substr($15,2);split(a,b,",") ;size=b[1];  array_size[miao]+=size; array_num[miao]++} END {for (miao in array_size){printf "%dM %s, counts:%s\n",int(array_size[miao]/1024/1024),miao,array_num[miao]}}'  | sort -rn | head
12M 2020-11-23T10:04:52, counts:994 # 每s请求12M, 即96Mbps带宽。 994次请求。
11M 2020-11-23T10:05:47, counts:948
11M 2020-11-23T10:05:27, counts:1032
10M 2020-11-23T10:05:54, counts:949
10M 2020-11-23T10:05:09, counts:976
10M 2020-11-23T10:05:01, counts:919
9M 2020-11-23T10:06:22, counts:879
9M 2020-11-23T10:06:21, counts:941
9M 2020-11-23T10:05:51, counts:932
9M 2020-11-23T10:05:48, counts:955


# nginx默认日志统计 每s请求
cat access.log | awk '{miao=substr($4,2); size=$10;  array_size[miao]+=size; array_num[miao]++} END {for (miao in array_size){printf "%dM %s, counts:%s\n",int(array_size[miao]/1024/1024),miao,array_num[miao]}}'  | sort -rn | head

# nginx ingress日志统计
kubectl logs --tail 2000  -n kube-system nginx-ingress-controller-7cc74857bb-6fmql   | awk '{miao=substr($6,2) ; array_count[miao]++; }END {for (miao in array_count) {print miao, array_count[miao]}}' | sort -rn


# 统计前, 同一秒出现多个日志，说明这个做字典的key. 值累加就是次数，值累加size就是总大小。
root@a3f71b491a2e:~# cat log.txt   | awk '{miao=substr($6,2) ; print miao}'
26/May/2021:13:48:07
26/May/2021:13:48:07
26/May/2021:13:48:07
26/May/2021:13:48:07
26/May/2021:13:48:08
26/May/2021:13:48:08
26/May/2021:13:48:09
26/May/2021:13:48:09
26/May/2021:13:48:09
26/May/2021:13:48:09

# 示例
kubectl logs --tail 20  -n kube-system nginx-ingress-controller-7cc74857bb-6fmql   | awk '{miao=substr($6,2) ; array_count[miao]++; array_size_in_sametime[miao]+=$12}END {for (miao in array_count) {printf "time: %s, counts: %s, size: %sKB\n",miao, array_count[miao],int(array_size_in_sametime[miao]/1024)}}' | sort -rn
time: 26/May/2021:14:01:48, counts: 2, size: 0KB
time: 26/May/2021:14:01:47, counts: 12, size: 14KB
time: 26/May/2021:14:01:46, counts: 6, size: 2KB


```

```bash
[root@izpxkqmt2zlej4z logs]# tail -n 100000 access-frontend-2020-11-23.log | head -n1 && date
2020-11-23T10:21:34

Mon Nov 23 10:23:28 CST 2020

#10万行约2分钟


[root@izpxkqmt2zlej4z logs]# tail -n 100000 access-frontend-2020-11-23.log  |awk -F'"' '{a=substr($15,2);split(a,b,",") ;size=b[1];url=$32; array_num[url]++;array_size[url]+=size}END{for(x in array_num){printf  "%dM %d %s\n",int(array_size[x]/1024/1024),array_num[x],x}}' | sort -rn -k1 | head
410M 768 /welfarecenter/static/img/xianwan2.6aef2a19.gif # 请求量最大的图片，2分钟410M的请求。
221M 819 /welfarecenter/static/js/chunk-libs.6293608b.js
70M 813 /welfarecenter/static/css/chunk-vantUI.0329ffb6.css
42M 41790 /android/v1/api
35M 822 /welfarecenter/static/js/chunk-vantUI.71055b2b.js
33M 773 /welfarecenter/static/css/chunk-1a1918df.17c48fbd.css
17M 771 /welfarecenter/static/js/chunk-1a1918df.03ad1532.js
6M 8767 /android/v1/login
5M 5 /public/share/js/video-7.6.4.js
4M 826 /welfarecenter/static/js/app.2ef2b11f.js


#>>> 410 * 1024 * 1024(bytes) / 120(s) / 1024 / 1024(M)
3
#1s的请求量是3M. 相当于24M带宽
# 让开发把这个地址放在七牛存储上, 让用户的流量到达七牛。
#带宽从80M降低至47M

```



# 2. 统计业务正常访问每秒请求并做限制(limit_req_zone)



注意，拒绝的日志在Nginx的错误日志中

![image-20201029100057074](http://myapp.img.mykernel.cn/image-20201029100057074.png)



如上可以观察到请求最多的域名是api.youninyouqu.com

安卓测试同事使用4G网络随便玩了半个小时，日志如下

![image-20201029100207985](http://myapp.img.mykernel.cn/image-20201029100207985.png)





现在我们对这段日志展开分析, 仅在api.youninyouqu.com,h5.youninyouqu.com域名下，所有接口每分钟请求

以下默认为1小时请求量

![image-20201029104751564](http://myapp.img.mykernel.cn/image-20201029104751564.png)

点开小时，即分钟请求量

![image-20201029104920608](http://myapp.img.mykernel.cn/image-20201029104920608.png)

## 2.1 单个IP所有URL每分钟请求量观察最多69个

点开最多的69次的，将显示每s请求量

## 2.2 单个IP所有URL每s请求量

所有URL，峰值请求25个

![image-20201029111306208](http://myapp.img.mykernel.cn/image-20201029111306208.png)



## 2.3 单IP单个URL的请求限制

/android/v1/api峰值8次

![image-20201029111706533](http://myapp.img.mykernel.cn/image-20201029111706533.png)

/android/v1/login峰值17次

![image-20201029111737814](http://myapp.img.mykernel.cn/image-20201029111737814.png)



nginx配置如下

```nginx
#nginx限制单IP请求速率, 注意nginx在不同的位置，其客户端ip地址对应变量不一样。


# 由于nginx在waf后面所以客户端ip为
limit_req_zone $http_x_forwarded_for zone=req_one:10m rate=3r/m; # SMS
limit_req_zone $http_x_forwarded_for zone=req_single_url_api:10m rate=8r/s; # api
limit_req_zone $http_x_forwarded_for zone=req_single_url_login:10m rate=17r/s; # login
limit_req_zone $http_x_forwarded_for zone=req_all_url:10m rate=25r/s; # 所有url


    limit_req_status 509;
  server {
        listen 443 ssl http2 ;
        server_name api.youninyouqu.com;

        client_max_body_size 100M;

        ssl on;
        ssl_certificate     /usr/local/nginx/certs/api-ssl/fullchain.pem;
        ssl_certificate_key /usr/local/nginx/certs/api-ssl/privkey.pem;
        ssl_protocols       TLSv1 TLSv1.1 TLSv1.2;
        # 添加代理首部
        proxy_set_header   Host    $host;
        proxy_set_header X-Real-IP $http_x_forwarded_For;
        proxy_set_header X-Forwarded-For $http_x_forwarded_For;
        location / {
             limit_req zone=req_all_url burst=5 nodelay; # 所有URL, 
             proxy_pass  http://http_requests;
        } 
        location /android/v1/api {
             limit_req zone=req_single_url_api burst=5 nodelay; # burst应对峰值, nodelay ，NGINX仍然会按照burst参数在队列中分配插槽（slot）以及利用已配置的限流，但是不是通过间隔地转发队列中的请求。相反，当某个请求来的太快，只要队列中有可用的空间（slot），NGINX会立即转发它。该插槽（slot）被标记为“已使用”，并且不会被释放给另一个请求，一直到经过适当的时间 rate=10r/s 指定的时间。即10s，又存在一个解决峰值的burst.
             proxy_pass  http://http_requests;
        } 
        location /android/v1/login {
             limit_req zone=req_single_url_login burst=5 nodelay;
             proxy_pass  http://http_requests;
        } 

```



观察日志

```bash
tail -f /usr/local/nginx/logs/error.log
```





## 2.4 有真实用户反馈被拦截

![image-20201029105524003](http://myapp.img.mykernel.cn/image-20201029105524003.png)

所有URL，每s峰值48



---



![image-20201029113524888](http://myapp.img.mykernel.cn/image-20201029113524888.png)

点开166

所有URL，每s峰值15

![image-20201029113744280](http://myapp.img.mykernel.cn/image-20201029113744280.png)

单个接口, 每s  15个。

![image-20201029113900679](http://myapp.img.mykernel.cn/image-20201029113900679.png)

## 2.4 配置真实用户的每s请求量

```bash
    limit_req_zone $http_x_forwarded_for zone=req_all_url:10m rate=45r/s;
```

```bash
[root@izpxkqmt2zlej4z logs]# /usr/local/nginx/sbin/nginx -t
nginx: the configuration file /usr/local/nginx/conf/nginx.conf syntax is ok
nginx: configuration file /usr/local/nginx/conf/nginx.conf test is successful
[root@izpxkqmt2zlej4z logs]# /usr/local/nginx/sbin/nginx -s reload


[root@izpxkqmt2zlej4z logs]# tail -f /usr/local/nginx/logs/error.log 
```





