---
title: 资源类型及配置清单
date: 2021-01-18 00:55:47
tags:
---



# api类型

- [x] kubectl
- [x] api  [地址](http://blog.mykernel.cn/2021/01/13/Kubernetes%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E5%8F%8A%E9%99%88%E8%BF%B0%E5%BC%8F%E5%91%BD%E4%BB%A4%E7%AE%A1%E7%90%86/#restful-api%E6%93%8D%E4%BD%9C)
- [x] dashboard

kubectl三种格式

陈述式命令: `kubectl create deployment/service`

陈述式对象: `kubectl create -f xxx.yaml`

声明式对象: `kubectl apply -f xxx.yaml`

# 资源类型

http://blog.mykernel.cn/2021/01/13/Kubernetes%E5%9F%BA%E7%A1%80%E6%A6%82%E5%BF%B5/#api

<!--more-->

# 陈述式对象

定义yaml格式，应该和显示的格式一样

```bash
[root@master ~]# kubectl get ns default -o yaml
apiVersion: v1
kind: Namespace                                    # 类型首字母大写
metadata:
  creationTimestamp: "2021-01-14T10:34:46Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:status:
        f:phase: {}
    manager: kube-apiserver
    operation: Update
    time: "2021-01-14T10:34:46Z"
  name: default
  resourceVersion: "200"
  uid: eaa3c369-2d77-49ea-8ead-6e202b032788
spec:
  finalizers:
  - kubernetes
status:
  phase: Active
```

或者

```bash
[root@master ~]# kubectl create ns develop --dry-run -o yaml
apiVersion: v1
kind: Namespace
metadata:
  name: develop
```



**陈述式对象配置**

```bash
[root@master basic]# pwd
/root/manifests/basic

[root@master basic]# cat develop-ns.yaml
apiVersion: v1
kind: Namespace
metadata:
  name: develop

[root@master basic]# kubectl create  -f develop-ns.yaml
namespace/develop created

[root@master basic]# kubectl get ns
NAME              STATUS   AGE
default           Active   3d14h
develop           Active   34s        # 出现
kube-node-lease   Active   3d14h
kube-public       Active   3d14h
kube-system       Active   3d14h
```



## --save-config=true

获取其yaml

```bash
[root@master basic]# kubectl get ns develop -o yaml
apiVersion: v1
kind: Namespace 
metadata: # 不存在annotation
  creationTimestamp: "2021-01-18T01:15:26Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:status:
        f:phase: {}
    manager: kubectl-create
    operation: Update
    time: "2021-01-18T01:15:26Z"
  name: develop
  resourceVersion: "316578"
  uid: b1801d55-7bd1-4758-bfdc-af3ca2e4fabd
spec:
  finalizers:
  - kubernetes
status:
  phase: Active


[root@master basic]# kubectl delete -f develop-ns.yaml 
namespace "develop" deleted


## 添加选项 ########
[root@master basic]# kubectl create --save-config=true -f develop-ns.yaml 
namespace/develop created
[root@master basic]# kubectl get ns develop -o yaml
apiVersion: v1
kind: Namespace
metadata:
  annotations:  # 不存在annotation， 保存了配置这个对象的json文件。
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Namespace","metadata":{"annotations":{},"name":"develop"}}
  creationTimestamp: "2021-01-18T01:17:14Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .: {}
          f:kubectl.kubernetes.io/last-applied-configuration: {}
      f:status:
        f:phase: {}
    manager: kubectl-create
    operation: Update
    time: "2021-01-18T01:17:14Z"
  name: develop
  resourceVersion: "316749"
  uid: fe4a81f5-a539-441e-90f2-7e4800cc9462
spec:
  finalizers:
  - kubernetes
status:
  phase: Active
```





# 声明式操作

优势：

- [x] 配置需要修改时，修改源文件，二次apply即可。               					create不可以。
- [x] apply可以应用目录，目录已经存在unchanged, 不存在就创建。	     create不可以。
- [x] apply默认会保存提交的方法。                                                                   create需要添加--save-config=true.

```bash
cp develop-ns.yaml prod-ns.yaml

[root@master basic]# cat prod-ns.yaml 
apiVersion: v1
kind: Namespace
metadata:
  name: prod


[root@master basic]# kubectl apply -f prod-ns.yaml 

```

二次创建

```bash
[root@master basic]#  kubectl create -f develop-ns.yaml 
Error from server (AlreadyExists): error when creating "develop-ns.yaml": namespaces "develop" already exists
[root@master basic]#  kubectl apply -f prod-ns.yaml 
namespace/prod unchanged
```



apply默认保存生成的配置

```bash
[root@master basic]# kubectl get ns prod -o yaml
apiVersion: v1
kind: Namespace
metadata:
  annotations: # apply默认会保存。
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","kind":"Namespace","metadata":{"annotations":{},"name":"prod"}}
  creationTimestamp: "2021-01-18T01:10:26Z"
  managedFields:
  - apiVersion: v1
    fieldsType: FieldsV1
    fieldsV1:
      f:metadata:
        f:annotations:
          .: {}
          f:kubectl.kubernetes.io/last-applied-configuration: {}
      f:status:
        f:phase: {}
    manager: kubectl-client-side-apply
    operation: Update
    time: "2021-01-18T01:10:26Z"
  name: prod
  resourceVersion: "316092"
  uid: 7a44b696-d640-47cd-a2c1-2e8590926d96
spec:
  finalizers:
  - kubernetes
status:
  phase: Active

```



# pod定义

获取帮助

- [x] 官方文档
- [x] `kubectl explain`



## 获取帮助

### 官方文档

一个资源到底属于`kubectl api-versions` 中哪个群组，哪个版本？

打开网站`cn.bing.com`, 搜索`kubernetes reference`, 进入[**Reference| Kubernetes**](https://kubernetes.io/docs/reference/)

https://kubernetes.io/docs/reference/       官方站点的下的docs/

选择当前使用的kubernetes版本, 当前我安装的是v1.20.2. `kubectl get nodes` 的VERSIONS字段。

![image-20210118092333572](http://myapp.img.mykernel.cn/image-20210118092333572.png)

![image-20210118092424819](http://myapp.img.mykernel.cn/image-20210118092424819.png)

进入https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/ 页面，对每一个资源资源格式，有非常详细的格式。所以namespace定义，查找namespace资源类型

![image-20210118092600237](http://myapp.img.mykernel.cn/image-20210118092600237.png)

应该有的字段

```yaml
apiVersion
kind
metadata
status
```



将来不应该定义pod, 直接定义deployment, 但是我们得从pod学起，查找左侧的pod [Pod v1 core](https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.20/#pod-v1-core)

- [x] 每个字段并非必须，有requirement才必须

- [x] 每个字段有值的类型: array, string, object



### 创建pod的通用格式

就算这么复杂，我们可以通过`kubectl get pod myapp-7d4b7b84b-986qx -o yaml`拿到已有pod的格式, 在修改

```bash
[root@master basic]# kubectl get pod
NAME                          READY   STATUS    RESTARTS   AGE
myapp-7d4b7b84b-986qx         1/1     Running   0          2d17h
ngx-deploy-6b44c98c55-22j8m   1/1     Running   0          2d18h

```

### kubectl explain

每次都上互联网查询文档太麻烦，要获取yaml格式指定选项的解释

```bash
[root@master basic]# kubectl explain pod
KIND:     Pod         # kind
VERSION:  v1          # pod的版本

DESCRIPTION:
     Pod is a collection of containers that can run on a host. This resource is
     created by clients and scheduled onto hosts.

FIELDS:
   apiVersion	<string>
     APIVersion defines the versioned schema of this representation of an
     object. Servers should convert recognized schemas to the latest internal
     value, and may reject unrecognized values. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources

   kind	<string>
     Kind is a string value representing the REST resource this object
     represents. Servers may infer this from the endpoint the client submits
     requests to. Cannot be updated. In CamelCase. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds

   metadata	<Object> # 
     Standard object's metadata. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata

   spec	<Object> # spec
     Specification of the desired behavior of the pod. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status

   status	<Object> # status
     Most recently observed status of the pod. This data may not be up to date.
     Populated by the system. Read-only. More info:
     https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status

```

#### 获取`<Ojbect>`帮助

只要后面有`<Ojbect>`的字段，均可以嵌套获取帮助

```bash
# 获取spec
kubectl explain pod.spec
   activeDeadlineSeconds	<integer>
   affinity	<Object>
   automountServiceAccountToken	<boolean>
   containers	<[]Object> -required-  # 对象，列表。并且必须
   dnsConfig	<Object>
   dnsPolicy	<string>
   enableServiceLinks	<boolean>
   ephemeralContainers	<[]Object>
   hostAliases	<[]Object>
   hostIPC	<boolean>
   hostNetwork	<boolean>
   hostPID	<boolean>
   hostname	<string>
   imagePullSecrets	<[]Object>
   initContainers	<[]Object>
   nodeName	<string>
   nodeSelector	<map[string]string>
   overhead	<map[string]string>
   preemptionPolicy	<string>
   priority	<integer>
   priorityClassName	<string>
   readinessGates	<[]Object>
   restartPolicy	<string>
   runtimeClassName	<string>
   schedulerName	<string>
   securityContext	<Object>
   serviceAccount	<string>
   serviceAccountName	<string>
   setHostnameAsFQDN	<boolean>
   shareProcessNamespace	<boolean>
   subdomain	<string>
     "<hostname>.<subdomain>.<pod namespace>.svc.<cluster domain>". If not
   terminationGracePeriodSeconds	<integer>
   tolerations	<[]Object>
   topologySpreadConstraints	<[]Object>
   volumes	<[]Object>


# 获取 containers
[root@master basic]# kubectl explain pod.spec.containers | grep '>'
RESOURCE: containers <[]Object>
   args	<[]string>
   command	<[]string>
   env	<[]Object>
   envFrom	<[]Object>
   image	<string>
   imagePullPolicy	<string>
   lifecycle	<Object>
   livenessProbe	<Object>
   name	<string> -required-
   ports	<[]Object>
   readinessProbe	<Object>
   resources	<Object>
   securityContext	<Object>
   startupProbe	<Object>
   stdin	<boolean>
   stdinOnce	<boolean>
   terminationMessagePath	<string>
   terminationMessagePolicy	<string>
   tty	<boolean>
   volumeDevices	<[]Object>
   volumeMounts	<[]Object>
   workingDir	<string>

# 获取env
[root@master basic]# kubectl explain pod.spec.containers.env | grep '>'
RESOURCE: env <[]Object>
   name	<string> -required-
   value	<string>
   valueFrom	<Object>
   
# 获取valueFrom
[root@master basic]# kubectl explain pod.spec.containers.env.valueFrom | grep '>'
RESOURCE: valueFrom <Object>
   configMapKeyRef	<Object>
   fieldRef	<Object>
     `metadata.labels['<KEY>']`, `metadata.annotations['<KEY>']`, spec.nodeName,
   resourceFieldRef	<Object>
   secretKeyRef	<Object>
```



#### 对象对应的yaml格式

`<Object>`

```bash
metadata:
	name: pod-demo
	namespace: default
```

`<[]Object>`

```bash
containers:
- k1: v
  k2: v
  k3: v
- k11: v
  k12: v
  ...
- 
-
```



## yaml格式创建自主式pod

不被控制器管理的pod, 这叫**自主式pod**

将来不应该这么用，现在为了理解方便

```bash
kubectl get pod  myapp-7d4b7b84b-986qx -o yaml > ~/manifests/basic/pod-demo-template.yaml

# 准备 自主式pod
cp  ~/manifests/basic/pod-demo-template.yaml ~/manifests/basic/pod-demo.yaml
```

```diff
 apiVersion: v1
 kind: Pod
 metadata:
-  creationTimestamp: "2021-01-15T08:09:00Z"
-  generateName: myapp-7d4b7b84b-
-  labels:
+  name: pod-demo        # 示例性pod
+  labels:               # 标签, 当前不重要
     app: myapp
-    pod-template-hash: 7d4b7b84b
-  managedFields:
-  - apiVersion: v1
-    fieldsType: FieldsV1
-    fieldsV1:
-      f:metadata:
-        f:generateName: {}
-        f:labels:
-          .: {}
-          f:app: {}
-          f:pod-template-hash: {}
-        f:ownerReferences:
-          .: {}
-          k:{"uid":"7f983c5b-5ed0-4df0-8374-0d556faf6273"}:
-            .: {}
-            f:apiVersion: {}
-            f:blockOwnerDeletion: {}
-            f:controller: {}
-            f:kind: {}
-            f:name: {}
-            f:uid: {}
-      f:spec:
-        f:containers:
-          k:{"name":"myapp"}:
-            .: {}
-            f:image: {}
-            f:imagePullPolicy: {}
-            f:name: {}
-            f:resources: {}
-            f:terminationMessagePath: {}
-            f:terminationMessagePolicy: {}
-        f:dnsPolicy: {}
-        f:enableServiceLinks: {}
-        f:restartPolicy: {}
-        f:schedulerName: {}
-        f:securityContext: {}
-        f:terminationGracePeriodSeconds: {}
-    manager: kube-controller-manager
-    operation: Update
-    time: "2021-01-15T08:09:00Z"
-  - apiVersion: v1
-    fieldsType: FieldsV1
-    fieldsV1:
-      f:status:
-        f:conditions:
-          k:{"type":"ContainersReady"}:
-            .: {}
-            f:lastProbeTime: {}
-            f:lastTransitionTime: {}
-            f:status: {}
-            f:type: {}
-          k:{"type":"Initialized"}:
-            .: {}
-            f:lastProbeTime: {}
-            f:lastTransitionTime: {}
-            f:status: {}
-            f:type: {}
-          k:{"type":"Ready"}:
-            .: {}
-            f:lastProbeTime: {}
-            f:lastTransitionTime: {}
-            f:status: {}
-            f:type: {}
-        f:containerStatuses: {}
-        f:hostIP: {}
-        f:phase: {}
-        f:podIP: {}
-        f:podIPs:
-          .: {}
-          k:{"ip":"10.244.2.4"}:
-            .: {}
-            f:ip: {}
-        f:startTime: {}
-    manager: kubelet
-    operation: Update
-    time: "2021-01-15T08:09:03Z"
-  name: myapp-7d4b7b84b-986qx
-  namespace: default
-  ownerReferences:
-  - apiVersion: apps/v1
-    blockOwnerDeletion: true
-    controller: true
-    kind: ReplicaSet
-    name: myapp-7d4b7b84b
-    uid: 7f983c5b-5ed0-4df0-8374-0d556faf6273
-  resourceVersion: "79312"
-  uid: 20fed6d0-43e7-477b-9f8e-799fbd46500d
-spec:
-  containers:
-  - image: ikubernetes/myapp:v1
-    imagePullPolicy: IfNotPresent
-    name: myapp
-    resources: {}
-    terminationMessagePath: /dev/termination-log
-    terminationMessagePolicy: File
-    volumeMounts:
-    - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
-      name: default-token-8qddj
-      readOnly: true
-  dnsPolicy: ClusterFirst
-  enableServiceLinks: true
-  nodeName: node02.magedu.com
-  preemptionPolicy: PreemptLowerPriority
-  priority: 0
-  restartPolicy: Always
-  schedulerName: default-scheduler
-  securityContext: {}
-  serviceAccount: default
-  serviceAccountName: default
-  terminationGracePeriodSeconds: 30
-  tolerations:
+  namespace: develop    # pod属于哪个名称空间
+spec:            # 属性
+  containers:           # pod运行多个容器. 
+  # - 表示引用列表项，是数组 array
+  - image: ikubernetes/myapp:v1           # 镜像
+    imagePullPolicy: IfNotPresent         # 此字段省略：指定镜像标签为latest或省略标签(默认latest), 则为always. 否则就是ifnotpresent;      目标节点没有镜像，怎么托。这里定义 always 本地有没有都托, ifnotpresent 本地没有才拉镜像, none  没有就不启动
+    name: myapp     #容器名
+    resources: {}  # 资源 cpu, ram 
+    #volumeMounts:  # 挂载卷
+    #- mountPath: /var/run/secrets/kubernetes.io/serviceaccount
+      #name: default-token-8qddj
+      #readOnly: true
+  dnsPolicy: ClusterFirst # 设置Pod的DNS策略。 默认为“ ClusterFirst”。 有效值 'ClusterFirstWithHostNet', 'ClusterFirst', 'Default' or 'None'。 DNSConfig中提供的DNS参数将与通过DNSPolicy选择的策略合并。 要与hostNetwork一起设置DNS选项，必须将DNS策略明确指定为'ClusterFirstWithHostNet'。
+  enableServiceLinks: true # 是否允许service引用。不引, service无法反代.
+  #nodeName: node02.magedu.com  # pod只能运行在哪个节点，不写由scheduler组件调度. 写上也可以调度，只是调度没有意义
+  priority: 0                   # Pod优先级, 
+  restartPolicy: Always         # Pod中的容器宕机怎么办？Always一宕机就重启.
+  schedulerName: default-scheduler # 调度
+  securityContext: {}             # 安全
+  serviceAccount: default     # sa
+  serviceAccountName: default     # 服务账户
+  terminationGracePeriodSeconds: 30 # 终止宽限期
+  tolerations:  # 容忍度, 与节点污点相关
   - effect: NoExecute
     key: node.kubernetes.io/not-ready
     operator: Exists
@@ -124,45 +35,8 @@
     key: node.kubernetes.io/unreachable
     operator: Exists
     tolerationSeconds: 300
-  volumes:
-  - name: default-token-8qddj
-    secret:
-      defaultMode: 420
-      secretName: default-token-8qddj
-status:
-  conditions:
-  - lastProbeTime: null
-    lastTransitionTime: "2021-01-15T08:09:00Z"
-    status: "True"
-    type: Initialized
-  - lastProbeTime: null
-    lastTransitionTime: "2021-01-15T08:09:03Z"
-    status: "True"
-    type: Ready
-  - lastProbeTime: null
-    lastTransitionTime: "2021-01-15T08:09:03Z"
-    status: "True"
-    type: ContainersReady
-  - lastProbeTime: null
-    lastTransitionTime: "2021-01-15T08:09:00Z"
-    status: "True"
-    type: PodScheduled
-  containerStatuses:
-  - containerID: docker://653264a35d3acba48f2ab55b18ce4303545907f984695e05f5887d8f1a08f29b
-    image: ikubernetes/myapp:v1
-    imageID: docker-pullable://ikubernetes/myapp@sha256:9c3dc30b5219788b2b8a4b065f548b922a34479577befb54b03330999d30d513
-    lastState: {}
-    name: myapp
-    ready: true
-    restartCount: 0
-    started: true
-    state:
-      running:
-        startedAt: "2021-01-15T08:09:02Z"
-  hostIP: 172.16.1.102
-  phase: Running
-  podIP: 10.244.2.4
-  podIPs:
-  - ip: 10.244.2.4
-  qosClass: BestEffort
-  startTime: "2021-01-15T08:09:00Z"
+  #volumes:     # 定义的卷
+  #- name: default-token-8qddj
+    #secret:
+      #defaultMode: 420
+      #secretName: default-token-8qddj

```

因此结果是

```bash
[root@master basic]# cat ~/manifests/basic/pod-demo.yaml

apiVersion: v1
kind: Pod
metadata:
  name: pod-demo        # 示例性pod
  labels:               # 标签, 当前不重要
    app: myapp
  namespace: develop    # pod属于哪个名称空间
spec:            # 属性
  containers:           # pod运行多个容器. 
  # - 表示引用列表项，是数组 array
  - image: ikubernetes/myapp:v1           # 镜像
    imagePullPolicy: IfNotPresent         # 此字段省略：指定镜像标签为latest或省略标签(默认latest), 则为always. 否则就是ifnotpresent;      目标节点没有镜像，怎么托。这里定义 always 本地有没有都托, ifnotpresent 本地没有才拉镜像, none  没有就不启动
    name: myapp     #容器名
    resources: {}  # 资源 cpu, ram 
    #volumeMounts:  # 挂载卷
    #- mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      #name: default-token-8qddj
      #readOnly: true
  dnsPolicy: ClusterFirst # 设置Pod的DNS策略。 默认为“ ClusterFirst”。 有效值 'ClusterFirstWithHostNet', 'ClusterFirst', 'Default' or 'None'。 DNSConfig中提供的DNS参数将与通过DNSPolicy选择的策略合并。 要与hostNetwork一起设置DNS选项，必须将DNS策略明确指定为'ClusterFirstWithHostNet'。
  enableServiceLinks: true # 是否允许service引用。不引, service无法反代.
  #nodeName: node02.magedu.com  # pod只能运行在哪个节点，不写由scheduler组件调度. 写上也可以调度，只是调度没有意义
  priority: 0                   # Pod优先级, 
  restartPolicy: Always         # Pod中的容器宕机怎么办？Always一宕机就重启.
  schedulerName: default-scheduler # 调度
  securityContext: {}             # 安全
  serviceAccount: default     # sa
  serviceAccountName: default     # 服务账户
  terminationGracePeriodSeconds: 30 # 终止宽限期
  tolerations:  # 容忍度, 与节点污点相关
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  #volumes:     # 定义的卷
  #- name: default-token-8qddj
    #secret:
      #defaultMode: 420
      #secretName: default-token-8qddj

```

启动pod

```bash
[root@master basic]# kubectl apply -f ~/manifests/basic/pod-demo.yaml
pod/pod-demo created 

[root@master basic]# kubectl get pod -n develop
NAME       READY   STATUS    RESTARTS   AGE
pod-demo   1/1     Running   0          32s

```



启动prod中的pod-demo

```bash
[root@master basic]# cat ~/manifests/basic/pod-demo-2.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-demo 
  namespace: prod
spec:            
  containers:           # pod运行多个容器. 
  - name: bbox
    image: busybox
    imagePullPolicy: IfNotPresent    
    # command <[]string>
    #command: # kubectl explain pod.spec.containers.command  command <[]string>
    #- "/bin/sh"
    #- "-c"
    #- "sleep 86400"
    command: ["/bin/sh","-c","sleep 86400"] # kubectl explain pod.spec.containers.command  
  - image: ikubernetes/myapp:v1           
    imagePullPolicy: IfNotPresent         
    name: myapp     
[root@master basic]# kubectl apply -f ~/manifests/basic/pod-demo-2.yaml
pod/pod-demo created
[root@master basic]# kubectl get pod -n prod
NAME       READY   STATUS              RESTARTS   AGE
				   # 表示在托镜像
pod-demo   0/2     ContainerCreating   0          7s

[root@master basic]# kubectl get pod -n prod
NAME       READY   STATUS    RESTARTS   AGE
pod-demo   2/2     Running   0          92s


# 获取yaml
 kubectl get pod -n prod pod-demo -o yaml
```



## 通过busybox访问pod-demo lo接口

```bash
kubectl describe pod/pod-demo -n prod

Containers:
  bbox:
  	...
  myapp:
  	...


[root@master basic]# kubectl exec pod-demo -n prod -c bbox -it -- /bin/sh
/ # 
/ # ifconfig # pod内容器共享网络名称空间
eth0      Link encap:Ethernet  HWaddr A2:12:56:F2:18:0B  
          inet addr:10.244.3.6  Bcast:10.244.3.255  Mask:255.255.255.0
          UP BROADCAST RUNNING MULTICAST  MTU:1450  Metric:1
          RX packets:6 errors:0 dropped:0 overruns:0 frame:0
          TX packets:1 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:0 
          RX bytes:480 (480.0 B)  TX bytes:42 (42.0 B)

lo        Link encap:Local Loopback  
          inet addr:127.0.0.1  Mask:255.0.0.0
          UP LOOPBACK RUNNING  MTU:65536  Metric:1
          RX packets:0 errors:0 dropped:0 overruns:0 frame:0
          TX packets:0 errors:0 dropped:0 overruns:0 carrier:0
          collisions:0 txqueuelen:1000 
          RX bytes:0 (0.0 B)  TX bytes:0 (0.0 B)

/ # netstat -tnl # 当前监听了80
Active Internet connections (only servers)
Proto Recv-Q Send-Q Local Address           Foreign Address         State       
tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      
/ # ps -ef       # 进程也没有监听，pod内的容器共享网络名称空间
PID   USER     TIME  COMMAND
    1 root      0:00 sleep 86400
   20 root      0:00 /bin/sh
   28 root      0:00 ps -ef
/ # 

/ # wget -O - -q 127.0.0.1    # 通过lo接口可以访问 同一个pod中另一个容器
Hello MyApp | Version: v1 | <a href="hostname.html">Pod Name</a>

```

## 查看pod日志

```bash
[root@master ~]# kubectl logs -h
		-f, --follow=false: Specify if the logs should be streamed.
	    -c, --container='': Print the logs of this container
		--tail=-1: Lines of recent log file to display. Defaults to -1 with no selector, showing all log lines otherwise
10, if a selector is provided.

[root@master ~]# kubectl logs pod-demo -n prod -c myapp
127.0.0.1 - - [18/Jan/2021:02:26:45 +0000] "GET / HTTP/1.1" 200 65 "-" "Wget" "-"
127.0.0.1 - - [18/Jan/2021:02:26:46 +0000] "GET / HTTP/1.1" 200 65 "-" "Wget" "-"

# 如果只有一个pod, 可以不写-c 容器名
[root@master ~]# kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
	# 此pod仅一个nginx容器
myapp-7d4b7b84b-986qx         1/1     Running   0          2d18h
ngx-deploy-6b44c98c55-22j8m   1/1     Running   0          2d18h
[root@master ~]# kubectl logs myapp-7d4b7b84b-986qx # 查看日志
10.244.0.0 - - [15/Jan/2021:08:09:10 +0000] "GET / HTTP/1.1" 200 65 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.25 Safari/537.36 Core/1.70.3861.400 QQBrowser/10.7.4313.400" "-"
10.244.0.0 - - [15/Jan/2021:08:09:10 +0000] "GET /favicon.ico HTTP/1.1" 404 571 "http://172.16.1.100:32224/" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/70.0.3538.25 Safari/537.36 Core/1.70.3861.400 QQBrowser/10.7.4313.400" "-"

```



## pod `spec.hostNetwork`

```diff
 sed 's@# .*@@g' ~/manifests/basic/pod-demo.yaml  > ~/manifests/basic/host-pod.yaml 


# ~/manifests/basic/host-pod.yaml 
apiVersion: v1
kind: Pod
metadata:
  name: pod-demo
  labels:
    app: myapp
+  namespace: default               # 默认
spec:
+  hostNetwork: true                     # 表示pod共享宿主机的网络名称空间，如果宿主机没有监听80, 宿主机直接监听在80端口
  containers:
  - image: ikubernetes/myapp:v1
    imagePullPolicy: IfNotPresent
    name: myapp     #容器名
    resources: {}
    #volumeMounts:  
    #- mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      #name: default-token-8qddj
      #readOnly: true
  dnsPolicy: ClusterFirst
  enableServiceLinks: true
  #nodeName: node02.magedu.com  
  priority: 0
  restartPolicy: Always
  schedulerName: default-scheduler
  securityContext: {}
  serviceAccount: default
  serviceAccountName: default
  terminationGracePeriodSeconds: 30
  tolerations:
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  #volumes:     
  #- name: default-token-8qddj
    #secret:
      #defaultMode: 420
      #secretName: default-token-8qddj


[root@master ~]# kubectl get pod
NAME                          READY   STATUS    RESTARTS   AGE
myapp-7d4b7b84b-986qx         1/1     Running   0          2d18h
ngx-deploy-6b44c98c55-22j8m   1/1     Running   0          2d19h
									  # 已经运行
pod-demo                      1/1     Running   0          23s


[root@master ~]# kubectl get pod -o wide
NAME                          READY   STATUS    RESTARTS   AGE     IP             NODE                NOMINATED NODE   READINESS GATES
myapp-7d4b7b84b-986qx         1/1     Running   0          2d18h   10.244.2.4     node02.magedu.com   <none>           <none>
ngx-deploy-6b44c98c55-22j8m   1/1     Running   0          2d19h   10.244.1.3     node01.magedu.com   <none>           <none>
																   # 共享宿主机的网络名称空间，直接是172.16.1.101
pod-demo                      1/1     Running   0          41s     172.16.1.101   node01.magedu.com   <none>           <none>

```

> 共享宿主机的网络名称空间，直接是172.16.1.101，可以直接外部访问

![image-20210118103824326](http://myapp.img.mykernel.cn/image-20210118103824326.png)

如果碰巧，宿主机几个pod都监听80, 就冲突了，所以并不常用。

```bash
# 清理
kubectl delete -f ~/manifests/basic/host-pod.yaml 

```





## pod `spec.containers.ports` 的hostPort访问

指定容器暴露的端口

pod与pod之间，不需要service暴露，直接访问目标pod的端口

```bash
[root@master ~]# kubectl explain pod.spec.containers.ports
KIND:     Pod
VERSION:  v1

RESOURCE: ports <[]Object>

DESCRIPTION:
     List of ports to expose from the container. Exposing a port here gives the
     system additional information about the network connections a container
     uses, but is primarily informational. Not specifying a port here DOES NOT
     prevent that port from being exposed. Any port which is listening on the
     default "0.0.0.0" address inside a container will be accessible from the
     network. Cannot be updated.

     ContainerPort represents a network port in a single container.

FIELDS:
   containerPort	<integer> -required-
     Number of port to expose on the pod's IP address. This must be a valid port
     number, 0 < x < 65536.

   hostIP	<string>
     What host IP to bind the external port to.

   hostPort	<integer>              # nodePort的service功能和此处不一样。nodePort是每个节点打开端口。hostPort只是所在节点有端口做DNAT.
     Number of port to expose on the host. If specified, this must be a valid
     port number, 0 < x < 65536. If HostNetwork is specified, this must match
     ContainerPort. Most containers do not need this.

   name	<string>
     If specified, this must be an IANA_SVC_NAME and unique within the pod. Each
     named port in a pod must have a unique name. Name for the port that can be
     referred to by services.

   protocol	<string>
     Protocol for port. Must be UDP, TCP, or SCTP. Defaults to "TCP". # 默认tcp

```

```diff
[root@master ~]# cat ~/manifests/basic/host-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: pod-demo        
  labels:               
    app: myapp
  namespace: default               # 默认
spec:            
  #hostNetwork: true                     # 表示pod共享宿主机的网络名称空间，如果宿主机没有监听80, 宿主机直接监听在80端口
  containers:           
  - image: ikubernetes/myapp:v1           
+    ports:   # ports <[]Object> 对象列表，所以格式如下
+    - containerPort: 80
+      hostPort: 8080                  # pod运行的节点上添加dnat规则，用户访问节点的8080，就映射到容器的80端口
+      name: http
+      protocol: TCP
    imagePullPolicy: IfNotPresent         
    name: myapp     #容器名
    resources: {}  
    #volumeMounts:  
    #- mountPath: /var/run/secrets/kubernetes.io/serviceaccount
      #name: default-token-8qddj
      #readOnly: true
  dnsPolicy: ClusterFirst 
  enableServiceLinks: true 
  #nodeName: node02.magedu.com  
  priority: 0                   
  restartPolicy: Always         
  schedulerName: default-scheduler 
  securityContext: {}             
  serviceAccount: default     
  serviceAccountName: default     
  terminationGracePeriodSeconds: 30 
  tolerations:  
  - effect: NoExecute
    key: node.kubernetes.io/not-ready
    operator: Exists
    tolerationSeconds: 300
  - effect: NoExecute
    key: node.kubernetes.io/unreachable
    operator: Exists
    tolerationSeconds: 300
  #volumes:     
  #- name: default-token-8qddj
    #secret:
      #defaultMode: 420
      #secretName: default-token-8qddj

```

```bash
[root@master ~]# kubectl apply -f ~/manifests/basic/host-pod.yaml
pod/pod-demo created
[root@master ~]# kubectl get pod -o wide
NAME                          READY   STATUS    RESTARTS   AGE     IP           NODE                NOMINATED NODE   READINESS GATES
myapp-7d4b7b84b-986qx         1/1     Running   0          2d18h   10.244.2.4   node02.magedu.com   <none>           <none>
ngx-deploy-6b44c98c55-22j8m   1/1     Running   0          2d19h   10.244.1.3   node01.magedu.com   <none>           <none>
																   # 注意不是主机地址了
pod-demo                      1/1     Running   0          8s      10.244.2.5   node02.magedu.com   <none>           <none>

```

> 注意不是主机地址了， 但是我们加了hostPort，所以直接通过DNAT端口访问

node02.magedu.com对应主机名是 172.16.1.102

![image-20210118104753037](http://myapp.img.mykernel.cn/image-20210118104753037.png)

但是集群其他node的8080，则不行



## pod暴露给用户

Pod 的网络 由flannel的10.244.0.0/16网络如何让集群外部访问？

- [x] service nodePort所有节点的**DNAT端口**
- [x] spec.containers.port.hostPort  pod运行的单个节点的**DNAT端口**
- [x] hostNetwork  pod运行的单个节点的 **容器直接运行的端口**

