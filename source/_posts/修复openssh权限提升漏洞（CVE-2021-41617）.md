---
title: "centos/ubuntu修复openssh权限提升漏洞（CVE-2021-41617）"
tags:
- 安全修复
- openssh
photos:
- http://myapp.img.mykernel.cn/image-20211123192427329.png
date: 2021-11-22 11:44:49
---

# 前言

阿里云暴出openssh有提权漏洞，目前有3种修复方式

- 镜像站点使用最新的openssh版本，更新
- 下载openssh二进制包进行覆盖二进制，重启openssh
- 基于二进制包制作rpm, 更新rpm

由于目前漏洞刚刚出现，镜像站点也没有最新的rpm, 为了方便批量分发，所以采用制作rpm的手法，参考了这些文章：

> https://cloud.tencent.com/developer/article/1767714
>
> https://www.jianshu.com/p/56e11c241df1

<!--more-->

# 基于srpm制作rpm

1. 下载srpm： http://pub.mirrors.aliyun.com/centos-vault/7.9.2009/os/Source/SPackages/

   在其中查找openssh

2. 下载源码: https://cdn.openbsd.org/pub/OpenBSD/OpenSSH/portable/

   下载openssh-8.8-p

3. 下载源码: `x11-ssh-askpass-1.2.4.1.tar.gz`

4. 制作

   - 安装`srpm` `rpm -ivh openssh-7.4p1-21.el7.src.rpm`

   - 复制源码到`rpmbuild/SOURCES`

   - 安装依赖 `yum install rpm-build zlib-devel openssl-devel gcc perl-devel pam-devel`

   - 准备sepc, 一般下载的官方源码目录下有相应程序的spec文件，直接复制到`rpm-build/SPECS`目录下

   - 修改spec

     取消debug分离

     ```bash
     %define debug_package %{nil}
     ```

     注释对openssl-devel检验，避免依赖检查不通过

     ```diff
     103 BuildRequires: openssl-devel >= 1.0.1
     +104 #BuildRequires: openssl-devel < 1.1
     105 %endif
     ```

     修改引用pam，避免覆盖原来的，不能登陆

     ```bash
     cp /etc/pam.d/sshd  ~/rpmbuild/SOURCES/
     ```

     `SPECS/openssh.spec`

     ```diff
     278 %if %{build6x}
     279 install -m644 contrib/redhat/sshd.pam.old $RPM_BUILD_ROOT/etc/pam.d/sshd
     280 %else
     +281 #install -m644 contrib/redhat/sshd.pam     $RPM_BUILD_ROOT/etc/pam.d/sshd
     +282 install -m644 $RPM_SOURCE_DIR/sshd         $RPM_BUILD_ROOT/etc/pam.d/sshd
     283 %endif
     ```

   - 在`rpmbuild`目录中，构建

     ```bash
     [root@1c7f6faa5aea rpmbuild]# cd SPECS/
     [root@1c7f6faa5aea SPECS]# ls
     openssh.spec
     [root@1c7f6faa5aea SPECS]# rpmbuild -bb ./openssh.spec
     ```

5. 获取rpm

   ```bash
   [root@1c7f6faa5aea rpmbuild]# ls RPMS/x86_64/
   openssh-8.8p1-1.el7.x86_64.rpm  openssh-askpass-8.8p1-1.el7.x86_64.rpm  openssh-askpass-gnome-8.8p1-1.el7.x86_64.rpm  openssh-clients-8.8p1-1.el7.x86_64.rpm  openssh-server-8.8p1-1.el7.x86_64.rpm
   ```

6. 安装rpm

   - 当前版本

     ```bash
     [root@1c7f6faa5aea ~]# ssh -V
     OpenSSH_7.4p1, OpenSSL 1.0.2k-fips  26 Jan 2017
     ```

   - 更新版本

     ```bash
     cd /root/rpmbuild/RPMS/x86_64
     yum update ./*.rpm
     
     [root@1c7f6faa5aea x86_64]# ssh -V
     OpenSSH_8.8p1, OpenSSL 1.0.2k-fips  26 Jan 2017
     ```




# ubuntu 以deb包形式追踪源码安装的文件

1. 下载源码

2. 安装依赖

   ```bash
   # openssh的pam, zlib依赖
   apt install libpam0g-dev zlib1g-dev
   
   # 构建时的依赖工具
   apt-get install checkinstall
   wget https://mirrors.edge.kernel.org/ubuntu/pool/universe/a/auto-apt/auto-apt_0.3.24_amd64.deb
   dpkg -i auto-apt_0.3.24_amd64.deb
   ```

   > https://help.ubuntu.com/community/CheckInstall

3. 编译

   ```bash
   auto-apt update
   auto-apt run ./configure  --with-pam --with-md5-passwords 
   ```

   > https://help.ubuntu.com/community/AutoApt
   >
   > `auto-apt` 从源构建时，缺少head, 就自动安装

4. 安装

   ```bash
   make
   checkinstall # 将会替代make install, 只不过可以将make install的所有文件追踪，方便卸载。不是用来打包的。
   ```



# ubuntu制作deb

http://packaging.ubuntu.com/html/







