---
title: 2021-04-10 4次面试总结
date: 2021-04-10 09:57:11
tags:
- 个人日记
---



昨天有4次面试，亿安永道、北京联众信安、九州鱼乐、云存科技、管家婆云、大米科技

亿安永道：        外包

北京联众信安： 对接政府项目

九州鱼乐：        海外游戏

云存科技：        区块链

管家婆云：        ERP 

大米科技：        餐管APP



大致面试问的有如下几个问题 k8s和cicd比较多, mysql备份，zabbix监控，服务器维护，haproxy/nginx区别, nginx模块，ddos攻击防护，优化linux系统。

# k8s相关
<!--more-->

## k8s组件

master主要由 kube-apiserver, kube-controller-manager和kube-scheduler3个组件，以及集群状态存储etcd服务组成。

node主要包含kubelet, kube-proxy及窗口运行时(docker/containerd)组成，它们承载各类应用容器。

 

apiserver: 对不同类型应用生命周期管理，部署、缩放、滚动更新等。输出restful api接口给用户，存储集群状态数据通过此网关完成认证、授权、准入控制。

controller-manager: 各解循环驱动api对象逼近期望状态。

scheduler: 为pod创建请求，分配一个节点，匹配节点时考量硬件、软件和约束，亲和、反亲和规范及数据的局部性等特性。

etcd: 存储集群状态数据，apiserver惟一与etcd通信。



kubelet: 接收master发来的指令，加载pod配置清单，通过容器运行时创建、启动、监听容器。

kube-proxy: 把service资源对象转换成iptables/ipvs规则。

## deployment区别 

replicaset: pod数量、伸缩、Pod健康。

deployment: 基于replicaset, 滚动更新，自动回滚，金丝雀部署，蓝绿部署。编排无状态应用。

statefulset: healess service+statefulset资源组成。借助volumeClaimTemplate静态或动态pv供给方式为各pod资源提供专有且固定的存储资源。

daemonset: 每个节点 一个

job: 串行或并行运行任务。

cronjob: 定时任务。

## k8s网络

Pod网络通过cni插件，实现有flannel, canal, calico. 

flannel: 

- [x] vxlan: overlay网络模型：lvs dr

- [x] host-gw: 动态路由

- [x] vxlan+ directrouting: 同内网host-gw, 跨内网升级vxlan

  

calico:

- [x] IPIP: ip外层加ip
- [x] bgp： 更大网络使用bgp协议，更小的网络开销。需要路由支持BGP协议。

canal是flannel配置网络，cannal完成策略配置。

# cicd流程

gitlab搭建后，默认root账号，创建项目，添加开发用户，用户与项目绑定有 管理员、维护人员、开发人员、只读角色。然后项目中的子项目都继承项目的权限，比如创建一个安卓的仓库，初始化一个安卓忽略的包，配置仓库有开发推送的权限。把账号和密码给开发人员。对于程序配置文件，一个仓库单独管理。

开发人员开发好，推送后，jenkins这边通过git插件选择分支，参数化构建插件选择不同的环境（生产环境，灰度环境，预发，测试环境），发布就是选择不同的分支和不同的环境，生产上线就是：裸机运行：拉代码，编译，拉git配置，haproxy sock下线一个，推送编译结果和配置，重启应用，haproxy上线。k8s就是：拉代码，编译，构建镜像，推harbor, 使用kubectl进行滚动更新。 

# mysql备份

mysqldump⽀持基于innodb的热备份，但是由于是逻辑备份，所以速度不是很快，适合备份数据⽐较⼩的 场景

Mysqldump完全备份+⼆进制⽇志可以实现基于时间点的恢复。 



percona提供的xtrabackup⼯具 

⽀持innodb的物理热备份，⽀持完全备份，增量备份，⽽且速度⾮常快，⽀持innodb存储的数据在不同数据库之间迁移，⽀持复制模式下的从机备份恢复备份恢复，为了让xtrabackup⽀持更多的 功能扩展 

可以设⽴独⽴表空间，打开 innodb_fifile_per_table功能，启⽤之后可以⽀持单独的表备份 

# zabbix/prometheus自定义监控

zabbix agent执行脚本，采集数据至server, server通过web展示，触发器告警，脚本发送告警至不同的媒介。

prometheus 配置target, 在目标主机运行编写的脚本，采集数据至prometheus server, promql定义报警阈值，grafana通过promql查询绘制图形。



# 300台主机维护

管理3百台服务器的⽅式： 

1）设定跳板机，使⽤统⼀账号登录，便于安全与登录的考量。 

2）使⽤salt、ansiable、puppet进⾏系统的统⼀调度与配置的统⼀管理。 

3）建⽴简单的服务器的系统、配置、应⽤的cmdb信息管理。便于查阅每台服务器上的各种 

信息记录。 

# haproxy/nginx区别

LVS： 是基于四层的转发  高并发 不能动静分离，成本高

HAproxy： 是基于四层和七层的转发，是专业的代理服务器  支持Session的保持

Nginx： 是WEB服务器，缓存服务器，⼜是反向代理服务器，可以做七层的转发 

# nginx模块

rewrite模块，实现重写功能 

access模块：来源控制 

ssl模块：安全加密 

ngx_http_gzip_module：网络传输压缩模块 

ngx_http_proxy_module 模块实现代理 

ngx_http_upstream_module模块实现定义后端服务器列表 

ngx_cache_purge实现缓存清除功能 

# ddos攻击防护

内核参数：tcp_syncookies  SYN Cookies技术, 试图保护套接字免受syn flood攻击 ， tcp_max_syn_backlog 增大半连接队列空间，容纳更多半连接，   tcp_syn_retries   缩短syn半连接的Timeout，即几次重传syn+ack的总时长调小。

iptables定时添加和清理

```bash
#!/bin/bash
#
#********************************************************************
#Author:                songliangcheng
#QQ:                    2192383945
#Date:                  2021-03-08
#FileName：             /usr/local/bin/ddos.sh
#URL:                   http://liangcheng.mykernel.cn
#Description：          如果IP只封禁30分钟，就30分钟执行一次crontab
#Copyright (C):        2021 All rights reserved
#********************************************************************
syn_recv_per_ip=5

# 添加DDOS链, INPUT引用
iptables -N DDOS 2>/dev/null
if iptables -vnL INPUT | awk '{print $3}' | grep -q DDOS; then
  true
else
  iptables -I INPUT -j DDOS
fi

# 解封之前封禁的IP
for ip in $(cat /var/tmp/clear); do
  LINE=$(iptables --line -vnL DDOS | grep $ip | awk '{print $1}')
  iptables -D DDOS $LINE
  echo "$ip clear at `date`" >>/var/log/ddos.log
done

# 把处于SYN-RECV的连接的源地址统计，其数量达到5个的IP统计，并禁用
ss -tnp -o state syn-recv | awk  'NR>=2{split($4,peer_addresses,":");print peer_addresses[1]}' | sort | uniq -c | sort -rn | awk -v syn_recv_per_ip=$syn_recv_per_ip '{if ($1 >=syn_recv_per_ip) {print $2}}' > /tmp/dropip
for i in $(cat /tmp/dropip); do
  /sbin/iptables -A DDOS -s $i -j DROP
  echo "$i kill at `date`" >>/var/log/ddos.log
done

# 把当前封禁的IP记录
mv /tmp/dropip /var/tmp/clear
rm -f /tmp/dropip
```

加入crontab

```bash
# 将以上内容放在/usr/local/bin/ddos.sh
root@master01:~# chmod +x /usr/local/bin/ddos.sh

# crontab -e
*/30 * * * * /usr/local/bin/ddos.sh
```



# 优化linux系统

不⽤root，添加普通⽤户，通过sudo授权管理 

更改默认的远程连接SSH服务端⼝及禁⽌root⽤户远程连接 

定时⾃动更新服务器时间 

配置国内yum源 

关闭selinux及iptables（iptables⼯作场景如果有外⽹IP⼀定要打开，⾼并发除外） 

调整⽂件描述符的数量精简开机启动服务（crond rsyslog network sshd） 

内核参数优化（/etc/sysctl.conf）更改字符集，⽀持中⽂，但建议还是⽤英⽂字符集，防⽌ 乱码

锁定关键系统⽂件 

清空/etc/issue，去除系统及内核版本登录前的屏幕显示 

